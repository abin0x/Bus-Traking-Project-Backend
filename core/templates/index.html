<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fleet Command Center</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* --- VARIABLES --- */
        :root { --primary: #0f172a; --accent: #3b82f6; --surface: #ffffff; --border: #e2e8f0; --text-main: #1e293b; --text-sub: #64748b; }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; overflow: hidden; }
        #map-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; }

        /* --- NAVBAR --- */
        .navbar {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            padding: 10px 20px; border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            z-index: 2000; display: flex; gap: 15px; border: 1px solid rgba(255,255,255,0.5);
        }
        .nav-btn {
            background: transparent; border: none; font-size: 0.9rem; font-weight: 600;
            color: var(--text-main); cursor: pointer; padding: 8px 16px; border-radius: 20px;
            transition: all 0.2s; display: flex; align-items: center; gap: 8px;
        }
        .nav-btn:hover { background: #f1f5f9; color: var(--accent); }
        .nav-btn.active { background: var(--accent); color: white; box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3); }

        /* --- SIDEBAR --- */
        .sidebar { position: absolute; top: 80px; bottom: 20px; left: 20px; width: 360px; background: var(--surface); border-radius: 16px; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1); display: flex; flex-direction: column; z-index: 1000; border: 1px solid var(--border); transition: transform 0.3s ease; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); background: #f8fafc; border-radius: 16px 16px 0 0; }
        .brand { font-size: 1.1rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        .bus-list { flex: 1; overflow-y: auto; padding: 16px; }
        .bus-card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .bus-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 15px -3px rgba(0,0,0,0.05); }
        .bus-card.active { border-color: var(--accent); background: #f0f9ff; border-left: 4px solid var(--accent); }
        
        .bus-card.offline { opacity: 0.6; background: #f8fafc; border-left: 4px solid #94a3b8; filter: grayscale(100%); }
        .bus-card.offline .badge { background: #e2e8f0 !important; color: #64748b !important; }
        
        .badge { font-size: 0.65rem; font-weight: 700; padding: 4px 10px; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-trip { background: #dcfce7; color: #166534; }
        .badge-ready { background: #fef9c3; color: #854d0e; }
        .badge-stop { background: #f3e8ff; color: #6b21a8; }

        /* --- RIGHT PANEL (UPDATED STYLE) --- */
        .details-panel { position: absolute; top: 20px; right: 20px; bottom: 20px; width: 380px; background: var(--surface); border-radius: 16px; box-shadow: -5px 0 30px rgba(0,0,0,0.1); z-index: 1001; transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; border: 1px solid var(--border); overflow: hidden; }
        .details-panel.open { transform: translateX(0); }
        
        .details-header { background: var(--primary); color: white; padding: 24px; position: relative; }
        .close-btn { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.1); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .close-btn:hover { background: rgba(255,255,255,0.2); }

        .timeline-container { padding: 20px; overflow-y: auto; flex: 1; background: #fdfdfd; }
        .timeline-step { position: relative; padding-left: 30px; margin-bottom: 20px; }
        .timeline-line { position: absolute; left: 9px; top: 5px; bottom: -25px; width: 2px; background: #e2e8f0; }
        .timeline-step:last-child .timeline-line { display: none; }
        
        .step-dot { position: absolute; left: 0; top: 0; width: 20px; height: 20px; border-radius: 50%; background: white; border: 3px solid #cbd5e1; z-index: 2; transition: all 0.3s; }
        .timeline-step.completed .step-dot { background: var(--text-sub); border-color: var(--text-sub); }
        .timeline-step.current .step-dot { background: var(--accent); border-color: white; box-shadow: 0 0 0 3px var(--accent); }
        
        .step-content h4 { font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin: 0; }
        .step-content p { font-size: 0.75rem; color: var(--text-sub); margin: 2px 0 0 0; }
        .timeline-step.completed h4 { text-decoration: line-through; color: #94a3b8; }

        /* --- SCHEDULE MODAL --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 3000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.active { display: flex; opacity: 1; }
        
        .schedule-box { background: white; width: 90%; max-width: 800px; max-height: 85vh; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; transform: translateY(20px); transition: transform 0.3s; }
        .modal-overlay.active .schedule-box { transform: translateY(0); }
        
        .schedule-header { padding: 20px 30px; background: #f8fafc; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .schedule-body { padding: 30px; overflow-y: auto; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; font-size: 0.8rem; text-transform: uppercase; color: var(--text-sub); border-bottom: 2px solid var(--border); }
        td { padding: 16px 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; color: var(--text-main); }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #f8fafc; }

        @media (max-width: 768px) {
            .navbar { width: 90%; justify-content: center; top: 15px; }
            .sidebar { top: auto; bottom: 0; left: 0; right: 0; width: 100%; height: 40vh; border-radius: 20px 20px 0 0; }
            .details-panel { width: 100%; height: 80vh; bottom: 0; top: auto; right: 0; left: 0; transform: translateY(110%); border-radius: 20px 20px 0 0; }
            .details-panel.open { transform: translateY(0); }
        }
    </style>
</head>
<body>

    <!-- MAP -->
    <div id="map-container"></div>

    <!-- NAVBAR -->
    <div class="navbar">
        <button class="nav-btn active"><i class="fas fa-map-marked-alt"></i> Live Map</button>
        <button class="nav-btn" onclick="openSchedule()"><i class="far fa-calendar-alt"></i> Schedule</button>
    </div>

    <!-- LEFT SIDEBAR -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="brand">
                <i class="fas fa-bus-alt text-blue-600"></i> FLEET<span style="font-weight:400;">TRACK</span>
            </div>
            <div class="flex gap-4 mt-3 text-[10px] uppercase font-bold text-gray-400">
                <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-green-500"></div> Active</span>
                <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-amber-400"></div> Ready</span>
            </div>
        </div>
        <div class="bus-list" id="bus-list-content">
            <div class="flex flex-col items-center justify-center h-full text-gray-400">
                <i class="fas fa-circle-notch fa-spin mb-2"></i>
                <span class="text-xs">Connecting...</span>
            </div>
        </div>
    </div>

    <!-- RIGHT DETAILS PANEL -->
    <div class="details-panel" id="details-panel">
        <div class="details-header">
            <button class="close-btn" onclick="closeDetails()"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-1" id="d-name">Bus Name</h2>
            <div class="flex items-center gap-2 text-sm opacity-90" id="d-route-info">
                <span>Start</span> <i class="fas fa-arrow-right text-xs"></i> <span>End</span>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mt-6">
                <div class="bg-white/10 rounded-lg p-3 backdrop-blur-sm">
                    <div class="text-[10px] uppercase opacity-70 mb-1">Speed</div>
                    <div class="text-xl font-bold"><span id="d-speed">0</span> <span class="text-sm font-normal">km/h</span></div>
                </div>
                <div class="bg-white/10 rounded-lg p-3 backdrop-blur-sm">
                    <div class="text-[10px] uppercase opacity-70 mb-1">Status</div>
                    <div class="text-sm font-bold uppercase tracking-wider" id="d-status">---</div>
                </div>
            </div>
        </div>

        <div class="timeline-container">
            <div class="text-xs font-bold uppercase text-gray-400 mb-6 tracking-widest">Live Route Progress</div>
            <div id="timeline-root">
                <!-- Timeline items injected here -->
            </div>
        </div>
    </div>

    <!-- SCHEDULE MODAL -->
    <div class="modal-overlay" id="schedule-modal">
        <div class="schedule-box">
            <div class="schedule-header">
                <h2 class="text-xl font-bold text-gray-800"><i class="far fa-clock text-blue-600 mr-2"></i> Bus Schedule</h2>
                <button onclick="closeSchedule()" class="text-gray-400 hover:text-red-500 text-xl"><i class="fas fa-times"></i></button>
            </div>
            
            <!-- Filters -->
            <div class="px-8 py-4 bg-gray-50 border-b border-gray-100 flex gap-4">
                <select id="day-filter" class="px-3 py-2 border rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="fetchSchedule()">
                    <option value="">All Days</option>
                    <option value="SUN_THU">Sun - Thu</option>
                    <option value="FRI">Friday</option>
                    <option value="SAT">Saturday</option>
                </select>
                <select id="dir-filter" class="px-3 py-2 border rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="fetchSchedule()">
                    <option value="">All Routes</option>
                    <option value="CAMPUS_TO_CITY">Campus → City</option>
                    <option value="CITY_TO_CAMPUS">City → Campus</option>
                </select>
            </div>

            <div class="schedule-body">
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Route</th>
                            <th>Trip Name</th>
                            <th>Bus No</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-table-body">
                        <!-- Data injected via JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // --- MAP INIT ---
        const map = L.map('map-container', { zoomControl: false }).setView([23.8103, 90.4125], 13);
        L.control.zoom({ position: 'topright' }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '© CARTO', maxZoom: 20 }).addTo(map);

        // --- STATE ---
        const markers = {};
        const busesData = {};
        let globalStops = [];
        let selectedBusId = null;

        // --- FETCH STOPS ---
        fetch('/api/stops/')
            .then(res => res.json())
            .then(data => {
                if(data.stops) {
                    globalStops = data.stops;
                    data.stops.forEach(stop => {
                        L.circleMarker([stop.lat, stop.lng], {
                            radius: 4, color: 'transparent', fillColor: '#cbd5e1', fillOpacity: 0.8
                        }).addTo(map);
                    });
                }
            });

        // --- WEBSOCKET ---
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const socket = new WebSocket(protocol + '//' + window.location.host + '/ws/tracking/');

        socket.onmessage = (e) => {
            const data = JSON.parse(e.data);
            const container = document.getElementById('bus-list-content');
            if(container.querySelector('.fa-spin')) container.innerHTML = '';

            if (data.buses) {
                data.buses.forEach(b => { b.is_live = true; updateBusState(b); });
            } else {
                data.is_live = true;
                updateBusState(data);
            }
        };

        // --- UPDATE LOGIC ---
        function updateBusState(bus) {
            bus.client_time = bus.is_live ? (Date.now()/1000) : (bus.last_seen || Date.now()/1000);

            if (bus.trip_status === 'IDLE') {
                removeBus(bus.id); return;
            }

            busesData[bus.id] = bus;
            updateMarker(bus);
            updateListCard(bus);
            checkGhostMode(bus);

            if (selectedBusId === bus.id) {
                updateRightPanel(bus);
            }
        }

        function removeBus(id) {
            if (markers[id]) { map.removeLayer(markers[id]); delete markers[id]; }
            const card = document.getElementById(`card-${id}`);
            if (card) card.remove();
            if (selectedBusId === id) closeDetails();
            delete busesData[id];
        }

        function updateMarker(bus) {
            let color = '#3b82f6';
            if (bus.at_stop) color = '#7c3aed';
            if (bus.trip_status === 'READY') color = '#eab308';

            const iconHtml = `<div class="w-8 h-8 rounded-full border-2 border-white shadow-lg flex items-center justify-center text-white text-xs transition-all duration-300" style="background:${color}">
                <i class="fas fa-bus"></i>
            </div>`;
            const icon = L.divIcon({ html: iconHtml, className: 'bg-transparent', iconSize: [32, 32] });

            if (markers[bus.id]) {
                markers[bus.id].setLatLng([bus.lat, bus.lng]).setIcon(icon);
                // Remove grayscale filter if online
                const el = markers[bus.id].getElement();
                if(el) el.style.filter = 'none';
            } else {
                const marker = L.marker([bus.lat, bus.lng], { icon: icon }).addTo(map);
                marker.on('click', () => selectBus(bus.id));
                markers[bus.id] = marker;
            }
        }

        function updateListCard(bus) {
            const container = document.getElementById('bus-list-content');
            let card = document.getElementById(`card-${bus.id}`);

            let badgeClass = 'bg-green-100 text-green-700';
            let badgeText = 'ON TRIP';
            if (bus.trip_status === 'READY') { badgeClass = 'bg-amber-100 text-amber-700'; badgeText = 'READY'; }
            else if (bus.at_stop) { badgeClass = 'bg-purple-100 text-purple-700'; badgeText = 'AT STOP'; }

            let depText = '';
            if (bus.trip_status === 'READY' && bus.next_departure) {
                depText = `<div class="mt-2 text-xs font-semibold text-amber-600 flex items-center gap-1"><i class="far fa-clock"></i> ${bus.next_departure}</div>`;
            }

            const html = `
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-bold text-gray-800">${bus.name}</h3>
                    <span class="text-[10px] font-bold px-2 py-1 rounded-full ${badgeClass}">${badgeText}</span>
                </div>
                <div class="flex items-center gap-4 text-xs text-gray-500">
                    <span class="flex items-center gap-1"><i class="fas fa-route"></i> ${bus.route}</span>
                    <span class="flex items-center gap-1"><i class="fas fa-tachometer-alt"></i> ${Math.round(bus.speed)} km/h</span>
                </div>
                ${depText}
            `;

            if (card) {
                card.innerHTML = html;
            } else {
                card = document.createElement('div');
                card.id = `card-${bus.id}`;
                card.className = 'bus-card';
                card.innerHTML = html;
                card.onclick = () => selectBus(bus.id);
                container.appendChild(card);
            }
        }

        // --- GHOST MODE ---
        setInterval(() => {
            const now = Date.now() / 1000;
            Object.keys(busesData).forEach(id => {
                const bus = busesData[id];
                const diff = now - bus.client_time;
                const isStand = (bus.trip_status === 'READY' || bus.speed < 1);
                const limit = isStand ? 120 : 1200;

                if (diff > limit) removeBus(id);
                else if (diff > 60) markOffline(id);
                else markOnline(id);
            });
        }, 2000);

        function checkGhostMode(bus) {
            const diff = (Date.now()/1000) - bus.client_time;
            if (diff > 60) markOffline(bus.id);
            else markOnline(bus.id);
        }

        function markOffline(id) {
            const card = document.getElementById(`card-${id}`);
            if (card) card.classList.add('offline');
            if (markers[id] && markers[id].getElement()) markers[id].getElement().style.filter = 'grayscale(100%)';
        }

        function markOnline(id) {
            const card = document.getElementById(`card-${id}`);
            if (card) card.classList.remove('offline');
            if (markers[id] && markers[id].getElement()) markers[id].getElement().style.filter = 'none';
        }

        // --- DETAILS PANEL ---
        function selectBus(id) {
            selectedBusId = id;
            document.querySelectorAll('.bus-card').forEach(c => c.classList.remove('active'));
            const card = document.getElementById(`card-${id}`);
            if(card) card.classList.add('active');
            
            document.getElementById('details-panel').classList.add('open');
            map.flyTo([busesData[id].lat, busesData[id].lng], 15, {duration: 1.5});
            updateRightPanel(busesData[id]);
        }

        function closeDetails() {
            document.getElementById('details-panel').classList.remove('open');
            selectedBusId = null;
            document.querySelectorAll('.bus-card').forEach(c => c.classList.remove('active'));
            map.flyTo([23.8103, 90.4125], 13);
        }

        function updateRightPanel(bus) {
            document.getElementById('d-name').innerText = bus.name;
            document.getElementById('d-route-info').innerHTML = `<span>${bus.origin}</span> <i class="fas fa-arrow-right text-xs text-gray-400"></i> <span>${bus.destination}</span>`;
            document.getElementById('d-speed').innerText = bus.speed.toFixed(1);
            
            let st = bus.trip_status === 'READY' ? 'READY TO DEPART' : 'ON TRIP';
            if (bus.at_stop) st = 'AT STATION';
            document.getElementById('d-status').innerText = st;

            // Render Timeline
            const container = document.getElementById('timeline-root');
            const stops = globalStops.filter(s => s.route === bus.route);
            const dir = bus.direction_status;
            
            if(dir === "CITY_TO_UNI") stops.sort((a,b) => b.order - a.order);
            else stops.sort((a,b) => a.order - b.order);

            let html = '';
            stops.forEach(stop => {
                let status = 'pending';
                const order = stop.order;
                const last = bus.last_order;

                if ((dir === "CITY_TO_UNI" && order > last) || (dir !== "CITY_TO_UNI" && order < last)) status = 'completed';
                else if (order === last) status = 'current';

                html += `
                    <div class="timeline-step ${status}">
                        <div class="timeline-line"></div>
                        <div class="step-dot"></div>
                        <div class="step-content">
                            <h4 class="${status === 'current' ? 'text-blue-600' : ''}">${stop.name} ${status === 'current' ? '<span class="text-[10px] bg-blue-600 text-white px-1 rounded ml-1">LIVE</span>' : ''}</h4>
                            <p>${status === 'completed' ? 'Passed' : (status === 'current' ? 'Current Location' : 'Upcoming')}</p>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html || '<div class="text-center text-gray-400 py-4">No route info</div>';
        }

        // --- SCHEDULE MODAL LOGIC ---
        function openSchedule() {
            document.getElementById('schedule-modal').classList.add('active');
            fetchSchedule();
        }
        function closeSchedule() {
            document.getElementById('schedule-modal').classList.remove('active');
        }

        function fetchSchedule() {
            const day = document.getElementById('day-filter').value;
            const dir = document.getElementById('dir-filter').value;
            let url = '/api/schedule/?';
            if(day) url += `day_type=${day}&`;
            if(dir) url += `direction=${dir}`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById('schedule-table-body');
                    tbody.innerHTML = '';
                    data.forEach(item => {
                        const row = `<tr>
                            <td class="font-bold text-blue-600">${item.formatted_time}</td>
                            <td>${item.direction_label}</td>
                            <td>${item.trip_name}</td>
                            <td>${item.bus_number}</td>
                        </tr>`;
                        tbody.innerHTML += row;
                    });
                });
        }

        // Initial Load
        fetch('/api/update-location/').then(res => res.json()).then(data => {
            if(data.status === 'success') data.buses.forEach(b => { b.is_live = false; updateBusState(b); });
        });

    </script>
</body>
</html>