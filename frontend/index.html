<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Tracking Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* [Keep all your existing CSS styles - they're fine] */
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --light: #f9fafb;
            --gray: #6b7280;
            --light-gray: #e5e7eb;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }

        /* [All your CSS styles remain the same] */
        /* ... */
        
        /* Add this for debug panel */
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            z-index: 10000;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .debug-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--danger);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10001;
        }
        
        .api-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .api-status.online {
            background-color: var(--secondary);
        }
        
        .api-status.offline {
            background-color: var(--danger);
        }
    </style>
</head>
<body>
    <!-- [Keep all your existing HTML structure] -->
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-bus"></i> Bus Tracking Dashboard</h1>
            <p>Real-time bus tracking and schedule management system</p>
            <div id="api-status-indicator" style="margin-top: 10px; font-size: 14px;">
                <span class="api-status offline"></span> API: Checking...
            </div>
        </div>
        
        <!-- [Rest of your HTML remains the same] -->
        <!-- ... -->
    </div>
    
    <!-- Debug Panel -->
    <div class="debug-panel" id="debug-panel">
        <h4 style="margin-bottom: 10px;">Debug Info</h4>
        <div id="debug-content"></div>
    </div>
    <div class="debug-toggle" id="debug-toggle">
        <i class="fas fa-bug"></i>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        // IMPORTANT: Change this to match your Django server URL
        const API_BASE = 'http://127.0.0.1:8000';  // Django default port
        // const API_BASE = 'http://localhost:8000'; // Alternative
        
        // Enable debug mode
        const DEBUG_MODE = true;
        
        // Global variables
        let map = null;
        let markers = [];
        let schedules = [];
        let buses = [];
        let debugLogs = [];

        // ============================================
        // DEBUG UTILITIES
        // ============================================
        function logDebug(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                time: timestamp,
                message: message,
                type: type
            };
            
            debugLogs.push(logEntry);
            
            if (DEBUG_MODE) {
                console.log(`[${timestamp}] ${message}`);
                
                // Update debug panel
                const debugContent = document.getElementById('debug-content');
                if (debugContent) {
                    const color = type === 'error' ? '#ef4444' : 
                                 type === 'success' ? '#10b981' : '#3b82f6';
                    debugContent.innerHTML += 
                        `<div style="color: ${color}; margin-bottom: 5px;">
                            [${timestamp}] ${message}
                        </div>`;
                    debugContent.scrollTop = debugContent.scrollHeight;
                }
            }
        }

        // ============================================
        // API HEALTH CHECK
        // ============================================
        async function checkApiHealth() {
            const endpoints = [
                '/api/update-location/',
                '/api/schedules/',
                '/api/stops/'
            ];
            
            const statusIndicator = document.getElementById('api-status-indicator');
            let allOnline = true;
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${API_BASE}${endpoint}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        logDebug(`✓ ${endpoint} is accessible`, 'success');
                    } else {
                        logDebug(`✗ ${endpoint} returned ${response.status}`, 'error');
                        allOnline = false;
                    }
                } catch (error) {
                    logDebug(`✗ ${endpoint} failed: ${error.message}`, 'error');
                    allOnline = false;
                }
            }
            
            if (statusIndicator) {
                if (allOnline) {
                    statusIndicator.innerHTML = 
                        '<span class="api-status online"></span> API: All endpoints online';
                    statusIndicator.style.color = '#10b981';
                } else {
                    statusIndicator.innerHTML = 
                        '<span class="api-status offline"></span> API: Some endpoints offline';
                    statusIndicator.style.color = '#ef4444';
                }
            }
            
            return allOnline;
        }

        // ============================================
        // ENHANCED FETCH WITH ERROR HANDLING
        // ============================================
        async function safeFetch(url, options = {}) {
            const fullUrl = url.startsWith('http') ? url : `${API_BASE}${url}`;
            
            logDebug(`Fetching: ${fullUrl}`);
            
            try {
                const response = await fetch(fullUrl, {
                    ...options,
                    headers: {
                        'Accept': 'application/json',
                        ...options.headers
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`Endpoint not found (404): ${url}`);
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    logDebug(`Non-JSON response from ${url}: ${text.substring(0, 100)}`, 'error');
                    throw new Error('Server returned non-JSON response');
                }
                
                const data = await response.json();
                logDebug(`Success: ${url}`, 'success');
                return data;
                
            } catch (error) {
                logDebug(`Fetch error: ${error.message}`, 'error');
                throw error;
            }
        }

        // ============================================
        // TAB MANAGEMENT (Keep your existing code)
        // ============================================
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all tabs
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                // Add active class to clicked tab
                button.classList.add('active');
                const tabId = button.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
                
                // Load data for the tab
                if (tabId === 'live-tracking') {
                    initializeMap();
                } else if (tabId === 'schedule') {
                    loadSchedules();
                } else if (tabId === 'buses') {
                    loadBuses();
                } else if (tabId === 'dashboard') {
                    loadDashboard();
                }
            });
        });

        // ============================================
        // DASHBOARD FUNCTIONS (Enhanced)
        // ============================================
        async function loadDashboard() {
            logDebug('Loading dashboard...');
            
            try {
                // Load bus data
                const busData = await safeFetch('/api/update-location/');
                
                if (busData.status === 'success') {
                    buses = busData.buses;
                    updateDashboardStats(buses);
                    updateLiveStatusTable(buses);
                } else {
                    throw new Error('Invalid response format from bus API');
                }
                
                // Load upcoming schedules
                await loadUpcomingSchedules();
                
            } catch (error) {
                logDebug(`Dashboard error: ${error.message}`, 'error');
                showNotification(`Dashboard error: ${error.message}`, 'error');
                
                // Show demo data for development
                if (DEBUG_MODE) {
                    showDemoData();
                }
            }
        }

        // Demo data for development
        function showDemoData() {
            logDebug('Showing demo data for development', 'warning');
            
            const demoBuses = [
                {
                    id: 'bus-001',
                    name: 'Demo Bus 1',
                    route: 'Route 1',
                    speed: 25,
                    trip_status: 'ON_TRIP',
                    status: 'moving',
                    current_stop: 'Mirpur 10',
                    last_seen: Date.now() / 1000
                },
                {
                    id: 'bus-002',
                    name: 'Demo Bus 2',
                    route: 'Route 2',
                    speed: 0,
                    trip_status: 'READY',
                    status: 'stopped',
                    current_stop: 'Campus Terminal',
                    last_seen: Date.now() / 1000
                }
            ];
            
            updateDashboardStats(demoBuses);
            updateLiveStatusTable(demoBuses);
            
            // Demo schedules
            const demoSchedules = [
                {
                    id: 1,
                    trip_name: 'ছাত্র-ছাত্রী',
                    direction: 'CAMPUS_TO_CITY',
                    direction_label: 'Campus to City',
                    day_type: 'SUN_THU',
                    departure_time: '08:30:00',
                    formatted_time: '08:30 AM',
                    bus_number: '১৭',
                    note: 'Via Mirpur Road',
                    is_active: true
                },
                {
                    id: 2,
                    trip_name: 'শিক্ষক',
                    direction: 'CITY_TO_CAMPUS',
                    direction_label: 'City to Campus',
                    day_type: 'SUN_THU',
                    departure_time: '09:15:00',
                    formatted_time: '09:15 AM',
                    bus_number: '১,২',
                    note: '',
                    is_active: true
                }
            ];
            
            displayUpcomingSchedules(demoSchedules);
            updateTodaySchedulesCount(demoSchedules.length);
        }

        // Update dashboard statistics
        function updateDashboardStats(buses) {
            const totalBuses = buses.length;
            const activeBuses = buses.filter(bus => bus.status !== 'offline').length;
            const onTripBuses = buses.filter(bus => bus.trip_status === 'ON_TRIP').length;
            
            document.getElementById('total-buses').textContent = totalBuses;
            document.getElementById('active-buses').textContent = activeBuses;
            document.getElementById('on-trip').textContent = onTripBuses;
            
            logDebug(`Stats: ${totalBuses} total, ${activeBuses} active, ${onTripBuses} on trip`);
        }

        // Update live status table
        function updateLiveStatusTable(buses) {
            const tbody = document.getElementById('live-status-table');
            tbody.innerHTML = '';
            
            // Sort buses by status (active first)
            const sortedBuses = [...buses].sort((a, b) => {
                if (a.status === 'offline' && b.status !== 'offline') return 1;
                if (a.status !== 'offline' && b.status === 'offline') return -1;
                return 0;
            });
            
            sortedBuses.slice(0, 5).forEach(bus => {
                const row = document.createElement('tr');
                
                // Determine status badge
                let statusBadge = '';
                if (bus.trip_status === 'ON_TRIP') {
                    statusBadge = `<span class="badge badge-on_trip">On Trip</span>`;
                } else if (bus.trip_status === 'READY') {
                    statusBadge = `<span class="badge badge-ready">Ready</span>`;
                } else {
                    statusBadge = `<span class="badge badge-idle">Idle</span>`;
                }
                
                // Determine movement badge
                const movementBadge = bus.status === 'moving' 
                    ? `<span class="badge badge-moving">Moving</span>`
                    : `<span class="badge badge-stopped">Stopped</span>`;
                
                row.innerHTML = `
                    <td><strong>${bus.name}</strong><br><small>${bus.route}</small></td>
                    <td>${statusBadge}</td>
                    <td>${bus.speed ? Math.round(bus.speed) : 0} km/h</td>
                    <td>${bus.current_stop || 'On Route'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load upcoming schedules
        async function loadUpcomingSchedules() {
            try {
                const now = new Date();
                const currentTime = now.getHours() * 60 + now.getMinutes();
                
                // Determine day type based on current day
                const day = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
                let dayType = 'SUN_THU';
                if (day === 5) dayType = 'FRI';
                else if (day === 6) dayType = 'SAT';
                else if (day === 2) dayType = 'TUE';
                
                // Load schedules for today
                const schedules = await safeFetch(`/api/schedules/?day_type=${dayType}`);
                
                // Filter upcoming schedules
                const upcoming = schedules.filter(schedule => {
                    const [hours, minutes] = schedule.departure_time.split(':');
                    const scheduleTime = parseInt(hours) * 60 + parseInt(minutes);
                    return scheduleTime > currentTime;
                }).slice(0, 5); // Get next 5 schedules
                
                updateTodaySchedulesCount(upcoming.length);
                displayUpcomingSchedules(upcoming);
                
            } catch (error) {
                logDebug(`Upcoming schedules error: ${error.message}`, 'error');
                
                if (DEBUG_MODE) {
                    // Show demo data
                    const demoUpcoming = [
                        {
                            trip_name: 'ছাত্র-ছাত্রী',
                            direction_label: 'Campus to City',
                            departure_time: '10:30:00',
                            formatted_time: '10:30 AM',
                            bus_number: '১৭',
                            note: 'Demo schedule'
                        }
                    ];
                    displayUpcomingSchedules(demoUpcoming);
                    updateTodaySchedulesCount(1);
                }
            }
        }

        // Update today's schedules count
        function updateTodaySchedulesCount(count) {
            document.getElementById('today-schedules').textContent = count;
        }

        // Display upcoming schedules
        function displayUpcomingSchedules(schedules) {
            const container = document.getElementById('upcoming-schedules');
            
            if (schedules.length === 0) {
                container.innerHTML = '<p class="text-center">No upcoming schedules for today</p>';
                return;
            }
            
            container.innerHTML = schedules.map(schedule => `
                <div class="schedule-card">
                    <div class="schedule-time">${schedule.formatted_time || schedule.departure_time}</div>
                    <div class="schedule-details">
                        <div class="schedule-detail">
                            <span class="detail-label">Trip:</span>
                            <span class="detail-value">${schedule.trip_name}</span>
                        </div>
                        <div class="schedule-detail">
                            <span class="detail-label">Direction:</span>
                            <span class="detail-value">${schedule.direction_label || schedule.direction}</span>
                        </div>
                        <div class="schedule-detail">
                            <span class="detail-label">Bus:</span>
                            <span class="detail-value">${schedule.bus_number}</span>
                        </div>
                        ${schedule.note ? `
                        <div class="schedule-detail">
                            <span class="detail-label">Note:</span>
                            <span class="detail-value">${schedule.note}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // ============================================
        // SCHEDULE MANAGEMENT (Enhanced)
        // ============================================
        async function loadSchedules(filters = {}) {
            try {
                // Build query string from filters
                const queryParams = new URLSearchParams();
                if (filters.direction) queryParams.append('direction', filters.direction);
                if (filters.day_type) queryParams.append('day_type', filters.day_type);
                if (filters.trip_name) queryParams.append('trip_name', filters.trip_name);
                
                const queryString = queryParams.toString() ? `?${queryParams.toString()}` : '';
                schedules = await safeFetch(`/api/schedules/${queryString}`);
                
                displaySchedulesTable(schedules);
                
            } catch (error) {
                logDebug(`Load schedules error: ${error.message}`, 'error');
                
                document.getElementById('schedule-table').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">
                            <div style="color: #ef4444; padding: 20px;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                                <p>Error loading schedules: ${error.message}</p>
                                ${DEBUG_MODE ? '<p><small>Running in demo mode with sample data</small></p>' : ''}
                            </div>
                        </td>
                    </tr>
                `;
                
                if (DEBUG_MODE) {
                    // Show demo schedules
                    setTimeout(() => {
                        const demoSchedules = [
                            {
                                id: 1,
                                trip_name: 'ছাত্র-ছাত্রী',
                                direction: 'CAMPUS_TO_CITY',
                                direction_label: 'Campus to City',
                                day_type: 'SUN_THU',
                                departure_time: '08:30:00',
                                formatted_time: '08:30 AM',
                                bus_number: '১৭',
                                note: 'Via Mirpur Road',
                                is_active: true
                            },
                            {
                                id: 2,
                                trip_name: 'শিক্ষক',
                                direction: 'CITY_TO_CAMPUS',
                                direction_label: 'City to Campus',
                                day_type: 'SUN_THU',
                                departure_time: '09:15:00',
                                formatted_time: '09:15 AM',
                                bus_number: '১,২',
                                note: 'Direct service',
                                is_active: true
                            }
                        ];
                        displaySchedulesTable(demoSchedules);
                    }, 1000);
                }
            }
        }

        // ============================================
        // NOTIFICATION SYSTEM
        // ============================================
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#ef4444'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                z-index: 1001;
                animation: slideIn 0.3s ease;
                display: flex;
                align-items: center;
                gap: 10px;
                max-width: 400px;
            `;
            
            const icon = type === 'success' ? 'fa-check-circle' : 
                        type === 'warning' ? 'fa-exclamation-triangle' : 'fa-exclamation-circle';
            
            notification.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // Add CSS animations if not already added
            if (!document.getElementById('notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // ============================================
        // DEBUG PANEL TOGGLE
        // ============================================
        document.getElementById('debug-toggle').addEventListener('click', () => {
            const panel = document.getElementById('debug-panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        });

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            logDebug('Dashboard initializing...');
            
            // Check API health
            await checkApiHealth();
            
            // Load dashboard
            await loadDashboard();
            
            // Set current time in departure time field
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const timeField = document.getElementById('departure_time');
            if (timeField) {
                timeField.value = `${hours}:${minutes}`;
            }
            
            // Auto-refresh dashboard every 30 seconds
            setInterval(() => {
                if (document.querySelector('#dashboard.tab-content.active')) {
                    loadDashboard();
                }
            }, 30000);
            
            logDebug('Dashboard initialized successfully', 'success');
            showNotification('Dashboard loaded successfully', 'success');
        });

        // ============================================
        // REMAINING FUNCTIONS (Keep your existing code)
        // ============================================
        // Keep all your other functions (initializeMap, loadBuses, etc.)
        // They should work with the new safeFetch function
        
        // [The rest of your JavaScript functions remain the same]
        // Just replace fetch() calls with safeFetch() for better error handling
        
    </script>
</body>
</html>